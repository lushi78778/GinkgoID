(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[393],{1104:function(e,t,n){Promise.resolve().then(n.bind(n,232))},232:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var s=n(7437),r=n(2265),a=n(7651),i=n(6013),o=n(495),l=n(6975),c=n(7776);let d={total_logins:482,new_users:36,success_rate:.93,failure_rate:.07,period:"最近 7 天",points:[{date:"周一",logins:60,new_users:5,success:56,failed:4},{date:"周二",logins:72,new_users:6,success:66,failed:6},{date:"周三",logins:80,new_users:7,success:75,failed:5},{date:"周四",logins:69,new_users:4,success:63,failed:6},{date:"周五",logins:90,new_users:8,success:82,failed:8},{date:"周六",logins:55,new_users:3,success:52,failed:3},{date:"周日",logins:56,new_users:3,success:52,failed:4}],top_errors:[{code:"invalid_client",count:5,description:"Client secret 无效"},{code:"invalid_grant",count:4,description:"授权码过期"},{code:"login_failed",count:3,description:"用户名或密码错误"}]};function u(){let{me:e}=(0,a.a)(),[t,n]=(0,r.useState)([]),[u,f]=(0,r.useState)(""),[h,m]=(0,r.useState)(null),[p,g]=(0,r.useState)(!1),v=(null==e?void 0:e.is_admin)||(null==e?void 0:e.is_dev),b=(0,r.useCallback)(async()=>{try{let e=await fetch("/api/my/clients",{credentials:"include"});if(!e.ok)throw Error(await e.text());let t=await e.json();if(!Array.isArray(t))throw Error("响应格式不正确");n(t),t.length&&!u&&f(t[0].client_id)}catch(e){c.Am.error((null==e?void 0:e.message)||"无法加载客户端列表")}},[u]),j=(0,r.useCallback)(async()=>{if(u){g(!0);try{var e,t,n,s,r,a,i;let o=await fetch("/api/my/clients/".concat(encodeURIComponent(u),"/analytics?period=7d"),{credentials:"include"});if(!o.ok)throw Error(await o.text());let l=await o.json();m({total_logins:Number(null!==(t=null!==(e=l.total_logins)&&void 0!==e?e:l.login_count)&&void 0!==t?t:0),new_users:Number(null!==(s=null!==(n=l.new_users)&&void 0!==n?n:l.new_user_count)&&void 0!==s?s:0),success_rate:Number(null!==(r=l.success_rate)&&void 0!==r?r:0),failure_rate:Number(null!==(a=l.failure_rate)&&void 0!==a?a:0),period:null!==(i=l.period)&&void 0!==i?i:"最近 7 天",points:Array.isArray(l.points)?l.points:Array.isArray(l.daily)?l.daily:d.points,top_errors:Array.isArray(l.top_errors)?l.top_errors:d.top_errors})}catch(e){c.Am.error((null==e?void 0:e.message)||"无法获取统计，展示示例数据"),m(d)}finally{g(!1)}}},[u]);(0,r.useEffect)(()=>{v&&b()},[v,b]),(0,r.useEffect)(()=>{v&&u&&j()},[v,u,j]);let w=(0,r.useMemo)(()=>h?Math.max(...h.points.map(e=>e.logins),1):1,[h]);return v?(0,s.jsx)("div",{className:"container py-10 space-y-6",children:(0,s.jsxs)(i.Zb,{children:[(0,s.jsxs)(i.Ol,{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(i.ll,{children:"应用分析"}),(0,s.jsx)(i.SZ,{children:"观察登录趋势、成功率和错误分布，指导容量规划与优化"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,s.jsx)("select",{value:u,onChange:e=>f(e.target.value),className:"h-9 min-w-[200px] rounded-md border border-border bg-background px-2 text-sm",children:t.map(e=>(0,s.jsx)("option",{value:e.client_id,children:e.client_name||e.client_id},e.client_id))}),(0,s.jsx)(o.z,{variant:"outline",size:"sm",onClick:j,disabled:p,children:p?"加载中...":"刷新"})]})]}),h&&(0,s.jsxs)(i.aY,{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-4",children:[(0,s.jsx)(x,{title:"登录总数",value:h.total_logins.toLocaleString(),hint:h.period}),(0,s.jsx)(x,{title:"新增授权用户",value:h.new_users.toLocaleString(),hint:h.period}),(0,s.jsx)(x,{title:"成功率",value:"".concat(Math.round(100*h.success_rate),"%"),hint:"成功登录次数 / 总登录次数"}),(0,s.jsx)(x,{title:"失败率",value:"".concat(Math.round(100*h.failure_rate),"%"),hint:"按错误响应统计"})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-foreground",children:"每日趋势"}),(0,s.jsx)("span",{className:"text-xs text-muted-foreground",children:"基于最近 7 天成功/失败请求"})]}),(0,s.jsx)("div",{className:"grid gap-3 md:grid-cols-7",children:h.points.map(e=>{let t=Math.round(e.success/w*140),n=Math.round(e.failed/w*140);return(0,s.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,s.jsxs)("div",{className:"flex h-40 w-12 flex-col justify-end gap-1",children:[(0,s.jsx)("div",{className:"w-full rounded-sm bg-emerald-500/70",style:{height:"".concat(t,"px")},title:"成功 ".concat(e.success)}),(0,s.jsx)("div",{className:"w-full rounded-sm bg-rose-400/70",style:{height:"".concat(n,"px")},title:"失败 ".concat(e.failed)})]}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.date})]},e.date)})})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold text-foreground",children:"常见错误"}),(0,s.jsx)("div",{className:"rounded-xl border border-border/60 bg-background/70",children:(0,s.jsxs)(l.iA,{children:[(0,s.jsx)(l.xD,{children:(0,s.jsxs)(l.SC,{children:[(0,s.jsx)(l.ss,{className:"w-[160px]",children:"错误码"}),(0,s.jsx)(l.ss,{children:"说明"}),(0,s.jsx)(l.ss,{className:"w-[120px]",children:"次数"})]})}),(0,s.jsxs)(l.RM,{children:[h.top_errors.map(e=>(0,s.jsxs)(l.SC,{children:[(0,s.jsx)(l.pj,{className:"font-mono text-xs",children:e.code}),(0,s.jsx)(l.pj,{className:"text-sm text-foreground",children:e.description||"-"}),(0,s.jsx)(l.pj,{className:"text-sm text-muted-foreground",children:e.count})]},e.code)),!h.top_errors.length&&(0,s.jsx)(l.SC,{children:(0,s.jsx)(l.pj,{colSpan:3,className:"py-8 text-center text-sm text-muted-foreground",children:"暂无错误数据。"})})]})]})})]})]})]})}):(0,s.jsx)("div",{className:"container py-10",children:(0,s.jsxs)(i.Zb,{children:[(0,s.jsxs)(i.Ol,{children:[(0,s.jsx)(i.ll,{children:"应用分析"}),(0,s.jsx)(i.SZ,{children:"需要开发者或管理员权限"})]}),(0,s.jsx)(i.aY,{children:(0,s.jsx)("a",{className:"btn",href:"/login?next=".concat(encodeURIComponent("/clients/analytics")),children:"使用开发者账户登录"})})]})})}function x(e){let{title:t,value:n,hint:r}=e;return(0,s.jsxs)("div",{className:"rounded-xl border border-border/60 bg-background/70 p-4",children:[(0,s.jsx)("div",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:t}),(0,s.jsx)("div",{className:"mt-2 text-2xl font-semibold text-foreground",children:n}),r&&(0,s.jsx)("div",{className:"text-xs text-muted-foreground mt-1",children:r})]})}},495:function(e,t,n){"use strict";n.d(t,{z:function(){return l}});var s=n(7437);n(2265);var r=n(1538),a=n(3027),i=n(7440);let o=(0,a.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function l(e){let{className:t,variant:n,size:a,asChild:l=!1,...c}=e,d=l?r.g7:"button";return(0,s.jsx)(d,{"data-slot":"button",className:(0,i.cn)(o({variant:n,size:a,className:t})),...c})}},6013:function(e,t,n){"use strict";n.d(t,{Ol:function(){return i},SZ:function(){return l},Zb:function(){return a},aY:function(){return c},ll:function(){return o}});var s=n(7437);n(2265);var r=n(7440);function a(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"card",className:(0,r.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",t),...n})}function i(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"card-header",className:(0,r.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",t),...n})}function o(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"card-title",className:(0,r.cn)("leading-none font-semibold",t),...n})}function l(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"card-description",className:(0,r.cn)("text-muted-foreground text-sm",t),...n})}function c(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"card-content",className:(0,r.cn)("px-6",t),...n})}},6975:function(e,t,n){"use strict";n.d(t,{RM:function(){return o},SC:function(){return l},iA:function(){return a},pj:function(){return d},ss:function(){return c},xD:function(){return i}});var s=n(7437);n(2265);var r=n(7440);function a(e){let{className:t,...n}=e;return(0,s.jsx)("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:(0,s.jsx)("table",{"data-slot":"table",className:(0,r.cn)("w-full caption-bottom text-sm",t),...n})})}function i(e){let{className:t,...n}=e;return(0,s.jsx)("thead",{"data-slot":"table-header",className:(0,r.cn)("[&_tr]:border-b",t),...n})}function o(e){let{className:t,...n}=e;return(0,s.jsx)("tbody",{"data-slot":"table-body",className:(0,r.cn)("[&_tr:last-child]:border-0",t),...n})}function l(e){let{className:t,...n}=e;return(0,s.jsx)("tr",{"data-slot":"table-row",className:(0,r.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",t),...n})}function c(e){let{className:t,...n}=e;return(0,s.jsx)("th",{"data-slot":"table-head",className:(0,r.cn)("text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...n})}function d(e){let{className:t,...n}=e;return(0,s.jsx)("td",{"data-slot":"table-cell",className:(0,r.cn)("p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...n})}},6264:function(e,t,n){"use strict";async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={credentials:"include",headers:{Accept:"application/json",...t.headers||{}},...t},s=await fetch(e,n);if(401===s.status){let e=encodeURIComponent(window.location.pathname+window.location.search);throw window.location.href="/login?next=".concat(e),Error("unauthorized")}let r=await s.text(),a=s.headers.get("Content-Type")||"",i=r;if(a.includes("application/json"))try{i=JSON.parse(r)}catch(e){}if(!s.ok){let e=i&&(i.error||i.message)||s.statusText;throw Error("string"==typeof e?e:JSON.stringify(i))}return i}async function r(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return s(e,{method:n.method||"POST",headers:{"Content-Type":"application/json",...n.headers||{}},body:JSON.stringify(t)})}n.d(t,{h:function(){return s},j:function(){return r}})},7651:function(e,t,n){"use strict";n.d(t,{H:function(){return o},a:function(){return l}});var s=n(7437),r=n(2265),a=n(6264);let i=(0,r.createContext)(null);function o(e){let{children:t}=e,[n,o]=(0,r.useState)(null),[l,c]=(0,r.useState)(!0),d=async()=>{try{let e=await (0,a.h)("/api/me");o(e)}catch(e){o(null)}finally{c(!1)}};(0,r.useEffect)(()=>{d()},[]);let u=async()=>{await fetch("/logout",{credentials:"include"}),window.location.href="/"},x=(0,r.useMemo)(()=>({me:n,loading:l,refresh:d,logout:u}),[n,l]);return(0,s.jsx)(i.Provider,{value:x,children:t})}function l(){return(0,r.useContext)(i)||{me:null,loading:!0,refresh:async()=>{},logout:async()=>{}}}},7440:function(e,t,n){"use strict";n.d(t,{cn:function(){return a}});var s=n(4839),r=n(6164);function a(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,r.m6)((0,s.W)(t))}}},function(e){e.O(0,[247,776,971,23,744],function(){return e(e.s=1104)}),_N_E=e.O()}]);