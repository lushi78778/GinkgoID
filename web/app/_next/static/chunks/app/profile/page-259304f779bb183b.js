(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[178],{8461:function(e,t,r){Promise.resolve().then(r.bind(r,7083))},7083:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return g}});var a=r(7437),s=r(2265),n=r(9343),i=r(546),o=r(1014),d=r(7651),l=r(6013),c=r(3102),u=r(7135),m=r(495),x=r(4421),f=r(7776);let h=i.Ryn({name:i.Z_8().trim().min(1,"姓名必填").max(60,"姓名长度不能超过 60 字"),email:i.Z_8().trim().email("邮箱格式不正确").max(120,"邮箱长度不能超过 120 字"),marketing:i.O72().optional()}),p=i.Ryn({oldPassword:i.Z_8().min(1,"请填写旧口令"),newPassword:i.Z_8().min(8,"新口令至少 8 位").regex(/[a-z]/i,"需包含字母").regex(/[0-9]/,"需包含数字"),confirmPassword:i.Z_8().min(1,"请再次输入新口令")}).refine(e=>e.newPassword===e.confirmPassword,{path:["confirmPassword"],message:"两次输入的口令不一致"});function g(){let{me:e,refresh:t}=(0,d.a)(),[r,i]=(0,s.useState)(!0),[g,b]=(0,s.useState)(null),[v,w]=(0,s.useState)(""),[j,y]=(0,s.useState)(null),[N,k]=(0,s.useState)(null),[_,P]=(0,s.useState)(!1),[S,C]=(0,s.useState)(!1),[O,Z]=(0,s.useState)(!1),{register:A,handleSubmit:z,reset:E,formState:{errors:T,isSubmitting:I,isDirty:F}}=(0,n.cI)({resolver:(0,o.F)(h)}),{register:J,handleSubmit:U,reset:Y,formState:{errors:M,isSubmitting:R}}=(0,n.cI)({resolver:(0,o.F)(p)});(0,s.useEffect)(()=>{(async()=>{i(!0);try{var e;let t=await fetch("/api/me",{credentials:"include"});if(!t.ok)throw Error(await t.text());let r=await t.json();E({name:r.name||"",email:r.email||"",marketing:!!r.marketing_opt_in}),b("boolean"==typeof r.email_verified?r.email_verified:"1"===r.email_verified),y(null!==(e=r.pending_email)&&void 0!==e?e:null),k("boolean"==typeof r.mfa_enabled?r.mfa_enabled:null),P(!!r.marketing_opt_in),w(r.email_status_message||"")}catch(e){f.Am.error((null==e?void 0:e.message)||"无法加载个人资料")}finally{i(!1)}})()},[E]);let D=(0,s.useMemo)(()=>!0===g?{label:"已验证",tone:"bg-emerald-500/10 text-emerald-600"}:!1===g?{label:"未验证",tone:"bg-amber-500/10 text-amber-600"}:{label:"未知",tone:"bg-slate-500/10 text-slate-600"},[g]),H=z(async e=>{try{let r=await fetch("/api/me",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name:e.name,email:e.email})});if(!r.ok)throw Error(await r.text());let a=await r.json();E({name:a.name||"",email:a.email||"",marketing:_}),f.Am.success("个人资料已保存"),t&&await t()}catch(e){f.Am.error((null==e?void 0:e.message)||"保存失败")}}),V=U(async e=>{try{let t=await fetch("/api/me/password",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({oldPassword:e.oldPassword,newPassword:e.newPassword})});if(204!==t.status)throw Error(await t.text());f.Am.success("口令已更新"),Y({oldPassword:"",newPassword:"",confirmPassword:""})}catch(e){f.Am.error((null==e?void 0:e.message)||"口令更新失败")}}),W=async()=>{Z(!0);try{let e=await fetch("/api/me/email/verify",{method:"POST",credentials:"include"});if(!e.ok)throw Error(await e.text());f.Am.success("验证邮件已发送，请查看收件箱"),w("已发送验证邮件")}catch(e){f.Am.error((null==e?void 0:e.message)||"无法发送验证邮件 (可能尚未实现后端接口) ")}finally{Z(!1)}},q=async()=>{i(!0);try{var e;let t=await fetch("/api/me",{credentials:"include"});if(!t.ok)throw Error(await t.text());let r=await t.json();b("boolean"==typeof r.email_verified?r.email_verified:"1"===r.email_verified),y(null!==(e=r.pending_email)&&void 0!==e?e:null),w(r.email_status_message||"")}catch(e){f.Am.error((null==e?void 0:e.message)||"无法刷新邮箱状态")}finally{i(!1)}},B=async e=>{P(e),C(!0);try{let t=await fetch("/api/me/preferences",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({marketing_opt_in:e})});if(!t.ok)throw Error(await t.text());f.Am.success("偏好设置已更新")}catch(t){f.Am.error((null==t?void 0:t.message)||"无法更新偏好 (后端可能尚未支持)"),P(!e)}finally{C(!1)}};return e?(0,a.jsxs)("div",{className:"container py-10 space-y-6",children:[(0,a.jsxs)(l.Zb,{children:[(0,a.jsxs)(l.Ol,{children:[(0,a.jsx)(l.ll,{children:"基础信息"}),(0,a.jsxs)(l.SZ,{children:["管理您的姓名与联系人邮箱。用户 ID：",(0,a.jsx)("span",{className:"font-mono",children:e.id})]})]}),(0,a.jsx)(l.aY,{children:(0,a.jsxs)("form",{onSubmit:H,className:"grid gap-4 max-w-xl",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(u._,{htmlFor:"name",children:"显示名称"}),(0,a.jsx)(c.I,{id:"name",placeholder:"姓名",...A("name")}),T.name&&(0,a.jsx)("span",{className:"text-xs text-red-500",children:T.name.message})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(u._,{htmlFor:"email",children:"邮箱"}),(0,a.jsx)(c.I,{id:"email",type:"email",placeholder:"name@example.com",...A("email")}),T.email&&(0,a.jsx)("span",{className:"text-xs text-red-500",children:T.email.message})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 text-sm text-muted-foreground",children:[(0,a.jsx)("span",{className:"rounded-full px-2 py-0.5 text-xs ".concat(D.tone),children:D.label}),j&&(0,a.jsxs)("span",{children:["新邮箱待验证：",j]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(0,a.jsx)(m.z,{type:"submit",disabled:I||!F,children:I?"保存中...":"保存修改"}),(0,a.jsx)(m.z,{type:"button",variant:"outline",onClick:q,disabled:r,children:"刷新状态"}),(0,a.jsx)(m.z,{type:"button",variant:"ghost",onClick:W,disabled:O,children:O?"发送中...":"发送验证邮件"})]}),v&&(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:v})]})})]}),(0,a.jsxs)(l.Zb,{children:[(0,a.jsxs)(l.Ol,{children:[(0,a.jsx)(l.ll,{children:"密码与安全"}),(0,a.jsx)(l.SZ,{children:"修改登录口令，建议开启 MFA 以提升安全性"})]}),(0,a.jsxs)(l.aY,{className:"grid gap-6 md:grid-cols-2",children:[(0,a.jsxs)("form",{onSubmit:V,className:"grid gap-4",children:[(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(u._,{htmlFor:"oldPassword",children:"旧口令"}),(0,a.jsx)(c.I,{id:"oldPassword",type:"password",autoComplete:"current-password",...J("oldPassword")}),M.oldPassword&&(0,a.jsx)("span",{className:"text-xs text-red-500",children:M.oldPassword.message})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(u._,{htmlFor:"newPassword",children:"新口令"}),(0,a.jsx)(c.I,{id:"newPassword",type:"password",autoComplete:"new-password",...J("newPassword")}),M.newPassword&&(0,a.jsx)("span",{className:"text-xs text-red-500",children:M.newPassword.message})]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)(u._,{htmlFor:"confirmPassword",children:"确认新口令"}),(0,a.jsx)(c.I,{id:"confirmPassword",type:"password",autoComplete:"new-password",...J("confirmPassword")}),M.confirmPassword&&(0,a.jsx)("span",{className:"text-xs text-red-500",children:M.confirmPassword.message})]}),(0,a.jsx)(m.z,{type:"submit",disabled:R,children:R?"保存中...":"更新口令"})]}),(0,a.jsxs)("div",{className:"rounded-xl border border-border/60 bg-background/70 p-4 text-sm text-muted-foreground",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-foreground",children:[(0,a.jsx)("span",{className:"font-semibold",children:"多因素认证"}),(0,a.jsx)("span",{className:"rounded-full px-2 py-0.5 text-xs ".concat(N?"bg-emerald-500/10 text-emerald-600":"bg-amber-500/10 text-amber-600"),children:N?"已开启":"未开启"})]}),(0,a.jsx)("p",{className:"mt-2",children:"MFA 管理入口已移动至“安全中心”。请前往该页面绑定 TOTP 应用、下载恢复码，并管理活跃会话。"}),(0,a.jsx)("a",{className:"btn mt-3 w-fit",href:"/security",children:"前往安全中心"})]})]})]}),(0,a.jsxs)(l.Zb,{children:[(0,a.jsxs)(l.Ol,{children:[(0,a.jsx)(l.ll,{children:"通知偏好"}),(0,a.jsx)(l.SZ,{children:"订阅安全提醒、登录通知以及产品公告"})]}),(0,a.jsxs)(l.aY,{className:"flex items-center justify-between rounded-lg border border-border/60 bg-muted/20 px-4 py-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:"接收产品与安全更新"}),(0,a.jsx)("div",{className:"text-sm text-muted-foreground",children:"包含登录安全提醒、重要策略变更与产品能力更新。"})]}),(0,a.jsx)(x.r,{checked:_,disabled:S,onCheckedChange:B})]})]})]}):(0,a.jsx)("div",{className:"container py-10",children:(0,a.jsxs)(l.Zb,{children:[(0,a.jsxs)(l.Ol,{children:[(0,a.jsx)(l.ll,{children:"个人资料"}),(0,a.jsx)(l.SZ,{children:"请先登录以查看和管理个人资料"})]}),(0,a.jsx)(l.aY,{children:(0,a.jsx)("a",{className:"btn",href:"/login?next=".concat(encodeURIComponent("/profile")),children:"去登录"})})]})})}},495:function(e,t,r){"use strict";r.d(t,{z:function(){return d}});var a=r(7437);r(2265);var s=r(1538),n=r(3027),i=r(7440);let o=(0,n.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}});function d(e){let{className:t,variant:r,size:n,asChild:d=!1,...l}=e,c=d?s.g7:"button";return(0,a.jsx)(c,{"data-slot":"button",className:(0,i.cn)(o({variant:r,size:n,className:t})),...l})}},6013:function(e,t,r){"use strict";r.d(t,{Ol:function(){return i},SZ:function(){return d},Zb:function(){return n},aY:function(){return l},ll:function(){return o}});var a=r(7437);r(2265);var s=r(7440);function n(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"card",className:(0,s.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",t),...r})}function i(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"card-header",className:(0,s.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",t),...r})}function o(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"card-title",className:(0,s.cn)("leading-none font-semibold",t),...r})}function d(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"card-description",className:(0,s.cn)("text-muted-foreground text-sm",t),...r})}function l(e){let{className:t,...r}=e;return(0,a.jsx)("div",{"data-slot":"card-content",className:(0,s.cn)("px-6",t),...r})}},3102:function(e,t,r){"use strict";r.d(t,{I:function(){return n}});var a=r(7437);r(2265);var s=r(7440);function n(e){let{className:t,type:r,...n}=e;return(0,a.jsx)("input",{type:r,"data-slot":"input",className:(0,s.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",t),...n})}},7135:function(e,t,r){"use strict";r.d(t,{_:function(){return i}});var a=r(7437);r(2265);var s=r(8364),n=r(7440);function i(e){let{className:t,...r}=e;return(0,a.jsx)(s.f,{"data-slot":"label",className:(0,n.cn)("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...r})}},4421:function(e,t,r){"use strict";r.d(t,{r:function(){return i}});var a=r(7437);r(2265);var s=r(7479),n=r(7440);function i(e){let{className:t,...r}=e;return(0,a.jsx)(s.fC,{"data-slot":"switch",className:(0,n.cn)("peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",t),...r,children:(0,a.jsx)(s.bU,{"data-slot":"switch-thumb",className:(0,n.cn)("bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0")})})}},6264:function(e,t,r){"use strict";async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={credentials:"include",headers:{Accept:"application/json",...t.headers||{}},...t},a=await fetch(e,r);if(401===a.status){let e=encodeURIComponent(window.location.pathname+window.location.search);throw window.location.href="/login?next=".concat(e),Error("unauthorized")}let s=await a.text(),n=a.headers.get("Content-Type")||"",i=s;if(n.includes("application/json"))try{i=JSON.parse(s)}catch(e){}if(!a.ok){let e=i&&(i.error||i.message)||a.statusText;throw Error("string"==typeof e?e:JSON.stringify(i))}return i}async function s(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return a(e,{method:r.method||"POST",headers:{"Content-Type":"application/json",...r.headers||{}},body:JSON.stringify(t)})}r.d(t,{h:function(){return a},j:function(){return s}})},7651:function(e,t,r){"use strict";r.d(t,{H:function(){return o},a:function(){return d}});var a=r(7437),s=r(2265),n=r(6264);let i=(0,s.createContext)(null);function o(e){let{children:t}=e,[r,o]=(0,s.useState)(null),[d,l]=(0,s.useState)(!0),c=async()=>{try{let e=await (0,n.h)("/api/me");o(e)}catch(e){o(null)}finally{l(!1)}};(0,s.useEffect)(()=>{c()},[]);let u=async()=>{await fetch("/logout",{credentials:"include"}),window.location.href="/"},m=(0,s.useMemo)(()=>({me:r,loading:d,refresh:c,logout:u}),[r,d]);return(0,a.jsx)(i.Provider,{value:m,children:t})}function d(){return(0,s.useContext)(i)||{me:null,loading:!0,refresh:async()=>{},logout:async()=>{}}}},7440:function(e,t,r){"use strict";r.d(t,{cn:function(){return n}});var a=r(4839),s=r(6164);function n(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,s.m6)((0,a.W)(t))}}},function(e){e.O(0,[247,776,782,971,23,744],function(){return e(e.s=8461)}),_N_E=e.O()}]);